<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/icons.css') }}"
    />
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  </head>
  <body class="bg-slate-100 flex">
    <div class="w-28">
      <nav class="fixed h-screen navbg-white">
        <ul class="flex flex-col justify-center h-full">
          <li class="flex hover:bg-slate-200 duration-75">
            <a href="/">
              <div class="flex w-full m-2">
                <div>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 384 512"
                    width="20"
                  >
                    <path
                      d="M240.5 224H352C365.3 224 377.3 232.3 381.1 244.7C386.6 257.2 383.1 271.3 373.1 280.1L117.1 504.1C105.8 513.9 89.27 514.7 77.19 505.9C65.1 497.1 60.7 481.1 66.59 467.4L143.5 288H31.1C18.67 288 6.733 279.7 2.044 267.3C-2.645 254.8 .8944 240.7 10.93 231.9L266.9 7.918C278.2-1.92 294.7-2.669 306.8 6.114C318.9 14.9 323.3 30.87 317.4 44.61L240.5 224z"
                    />
                  </svg>
                </div>
                <div>
                  <span class="link-text w-0 ml-2"> 新增電表 </span>
                </div>
              </div>
            </a>
          </li>

          <li class="flex hover:bg-slate-200 duration-75">
            <a href="/meter_list">
              <div class="flex w-full m-2">
                <div>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 384 512"
                    width="20"
                  >
                    <path
                      d="M288 248v28c0 6.6-5.4 12-12 12H108c-6.6 0-12-5.4-12-12v-28c0-6.6 5.4-12 12-12h168c6.6 0 12 5.4 12 12zm-12 72H108c-6.6 0-12 5.4-12 12v28c0 6.6 5.4 12 12 12h168c6.6 0 12-5.4 12-12v-28c0-6.6-5.4-12-12-12zm108-188.1V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V48C0 21.5 21.5 0 48 0h204.1C264.8 0 277 5.1 286 14.1L369.9 98c9 8.9 14.1 21.2 14.1 33.9zm-128-80V128h76.1L256 51.9zM336 464V176H232c-13.3 0-24-10.7-24-24V48H48v416h288z"
                    />
                  </svg>
                </div>
                <div>
                  <span class="link-text w-0 ml-2"> 電表總爛 </span>
                </div>
              </div>
            </a>
          </li>
        </ul>
      </nav>
    </div>

    <div class="w-full h-screen">
      <div class="fixed w-full h-14 block bg-red-500">
        <nav id="banner" class="mb-10">我是 NavBar 到時候討論功能</nav>
      </div>

      <div
        class="flex flex-col justify-center w-auto bg-white rounded-xl m-4 mt-20"
        id="app"
      >
        <div>
          <form action="/post" method="post">
            <div>
              <div id="IPSec" class="py-2">
                <input
                  type="radio"
                  id="UseIP"
                  name="selection"
                  value="UseIP"
                  checked
                />
                <label for="UseIP">Use IP</label>
                <br />
                <span>ip address:</span>
                <div>
                  <input
                    id="ip1"
                    type="number"
                    class="ipClass px-1 number one rounded-md border-gray-500 border-opacity-100 border"
                    maxlength="3"
                    max="255"
                    min="0"
                    name="ip1"
                    inputmode="numeric"
                  />
                  <span>.</span>
                  <input
                    id="ip2"
                    type="number"
                    class="ipClass px-1 number two rounded-md border-gray-500 border-opacity-100 border"
                    maxlength="3"
                    max="255"
                    min="0"
                    name="ip2"
                    inputmode="numeric"
                  />
                  <span>.</span>
                  <input
                    id="ip3"
                    type="number"
                    class="ipClass px-1 number three rounded-md border-gray-500 border-opacity-100 border"
                    maxlength="3"
                    max="255"
                    min="0"
                    name="ip3"
                    inputmode="numeric"
                  />
                  <span>.</span>
                  <input
                    id="ip4"
                    type="number"
                    class="ipClass px-1 number four rounded-md border-gray-500 border-opacity-100 border"
                    maxlength="3"
                    max="255"
                    min="0"
                    name="ip4"
                    inputmode="numeric"
                  />
                </div>
              </div>
              <div id="DomainSec" class="py-2">
                <input
                  type="radio"
                  id="UseDomain"
                  name="selection"
                  value="UseDomain"
                />
                <label for="UseDomain">Use Domain</label>
                <br />
                <span>Domain Name: </span>
                <div>
                  <input
                    id="domainName"
                    type="text"
                    class="px-1 number two rounded-md border-gray-500 border-opacity-100 border"
                    name="domainName"
                    disabled
                  />
                </div>
              </div>
            </div>
            <div id="PortSec" class="py-2">
              <span>port:</span>
              <input
                type="text"
                class="px-1 number rounded-md border-gray-500 border-opacity-100 border"
                max="65534"
                min="0"
                pattern="\d*"
                value="502"
                maxlength="5"
                placeholder="502"
                id="port"
                name="port"
                inputmode="numeric"
              />
            </div>
            <button
              class="bg-blue-500 rounded-md px-2 py-1 text-white modal-open"
              onclick="checkValue"
            >
              送出
            </button>
          </form>
        </div>
      </div>
    </div>

    <div
      class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center"
    >
      <div
        class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"
      ></div>

      <div
        class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto"
      >
        <!-- Add margin if you want to see some of the overlay behind the modal-->
        <div class="modal-content py-4 text-left px-6">
          <!--Title-->
          <div class="flex justify-between items-center pb-3">
            <p class="text-2xl font-bold">請確認資訊是否正確</p>
            <div class="modal-close cursor-pointer z-50">
              <svg
                class="fill-current text-black"
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 18 18"
              >
                <path
                  d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"
                ></path>
              </svg>
            </div>
          </div>

          <!--Body-->

          <div class="modalDiv"></div>

          <!--Footer-->
          <div class="flex justify-end pt-2">
            <button
              class="modal-close px-4 bg-indigo-500 p-3 rounded-lg text-white hover:bg-indigo-400"
              onclick="submitForm()"
            >
              確認
            </button>
            <button
              class="px-4 bg-transparent p-3 rounded-lg text-indigo-500 hover:bg-gray-100 hover:text-indigo-400 mr-2"
              onclick="toggleModal()"
            >
              關閉
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <style>
    /* Chrome, Safari, Edge, Opera */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Firefox */
    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
  <script>
    // if choose ip => disable domainName and enable ip
    document.querySelector("#UseIP").addEventListener("change", () => {
      document.querySelector("#domainName").value = "";
      document.querySelector("#domainName").disabled = true;
      for (const i of document.querySelectorAll(".ipClass")) {
        i.disabled = false;
      }
    });

    // if choose UseDomain => enable domainName and disable ip
    document.querySelector("#UseDomain").addEventListener("change", () => {
      document.querySelector("#domainName").disabled = false;
      for (const i of document.querySelectorAll(".ipClass")) {
        i.value = "";
        i.disabled = true;
      }
    });

    //  switch to the next input if reach the length of input
    document.querySelectorAll(".number").forEach(function (el) {
      // force enter number
      function onInputNum(e) {
        if (
          ((e.which != 8 && e.which != 0 && e.which < 48 && e.which != 13) ||
            e.which > 57) &&
          this.id != "domainName"
        ) {
          e.preventDefault();
        }

        // switch to next input
        if (this.value.length >= this.maxLength && this.id != "port") {
          currerentTag = this;

          while (
            currerentTag.nextElementSibling ||
            currerentTag.parentElement.parentElement.nextElementSibling
          ) {
            if (
              currerentTag.nextElementSibling &&
              (currerentTag.nextElementSibling.tagName.toLowerCase() ===
                "input" ||
                currerentTag.nextElementSibling.tagName.toLowerCase() ===
                  "button")
            ) {
              currerentTag = currerentTag.nextElementSibling;

              window.setTimeout(() => currerentTag.focus(), 0);
              break;
            } else if (
              !currerentTag.nextElementSibling &&
              !currerentTag.parentElement.parentElement.nextElementSibling.querySelector(
                "#DomainSec"
              )
            ) {
              currerentTag =
                currerentTag.parentElement.parentElement.parentElement.nextElementSibling.querySelector(
                  "input"
                );
              window.setTimeout(() => currerentTag.focus(), 0);
              break;
            } else {
              currerentTag = currerentTag.nextElementSibling;
            }
          }
        }
      }

      // if selecting an input section, select all text
      function selectAllInput(e) {
        this.select();
      }

      el.addEventListener("keyup", onInputNum.bind(el));
      el.addEventListener("focus", selectAllInput.bind(el));
    });

    // for 送出 BTN
    var openmodal = document.querySelector(".modal-open");
    openmodal.addEventListener("click", function (e) {
      e.preventDefault();
      if (checkValue()) {
        toggleModal();
      }
    });

    const overlay = document.querySelector(".modal-overlay");
    overlay.addEventListener("click", toggleModal);

    var closemodal = document.querySelectorAll(".modal-close");
    for (var i = 0; i < closemodal.length; i++) {
      closemodal[i].addEventListener("click", toggleModal);
      closemodal[i].addEventListener("click", clearNode);
    }

    function clearNode(e) {
      const modalDiv = document.querySelector(".modalDiv");
      while (modalDiv.lastElementChild) {
        modalDiv.removeChild(modalDiv.lastElementChild);
      }
    }

    document.onkeydown = function (evt) {
      evt = evt || window.event;
      var isEscape = false;
      if ("key" in evt) {
        isEscape = evt.key === "Escape" || evt.key === "Esc";
      } else {
        isEscape = evt.keyCode === 27;
      }
      if (isEscape && document.body.classList.contains("modal-active")) {
        clearNode();
        toggleModal();
      }
    };

    function toggleModal() {
      clearNode();

      const modal = document.querySelector(".modal");
      const modalDiv = document.querySelector(".modalDiv");
      modal.classList.toggle("opacity-0");
      modal.classList.toggle("pointer-events-none");
      if (document.querySelector("#UseIP").checked) {
        ipLists = document.querySelectorAll(".ipClass");
        let newDiv = document.createElement("div");
        newDiv.innerHTML = "IP Address:";
        modalDiv.appendChild(newDiv);
        for (const [index, el] of ipLists.entries()) {
          let newDiv = document.createElement("span");
          newDiv.innerHTML = el.value;
          modalDiv.appendChild(newDiv);
          if (!(index == ipLists.length - 1)) {
            newDiv = document.createElement("span");
            newDiv.innerHTML = ".";
            modalDiv.appendChild(newDiv);
          }
        }
      }

      if (document.querySelector("#UseDomain").checked) {
        let newDiv = document.createElement("div");
        newDiv.innerHTML = "Domain Name: ";
        modalDiv.appendChild(newDiv);
        newDiv = document.createElement("span");
        newDiv.innerHTML = document.querySelector("#domainName").value;
        modalDiv.appendChild(newDiv);
      }

      let newDiv = document.createElement("div");
      newDiv.innerHTML = "Port: " + document.querySelector("#port").value;
      modalDiv.appendChild(newDiv);
    }

    function checkValue() {
      let msg = "";
      if (document.querySelector("#UseIP").checked) {
        ipLists = document.querySelectorAll(".ipClass");
        for (const [index, el] of ipLists.entries()) {
          const ipVal = el.value;
          if (ipVal == "" || ipVal.length > 3 || ipVal > 255) {
            msg += "請確認ip的第" + (index + 1) + "欄\n";
          }
        }
        const portVal = document.querySelector("#port").value;
        if (
          portVal.length > 5 ||
          portVal > 65534 ||
          portVal < 0 ||
          portVal == ""
        ) {
          msg += "請確認port\n";
        }
        if (msg) {
          msg += "是否正確";
          alert(msg);
          return false;
        }
      }

      if (document.querySelector("#UseDomain").checked) {
        const domainVal = document.querySelector("#domainName").value;

        if (domainVal == "") {
          msg += "請確認domain name\n";
        }
        const portVal = document.querySelector("#port").value;

        if (
          portVal.length > 5 ||
          portVal > 65534 ||
          portVal < 0 ||
          portVal == ""
        ) {
          msg += "請確認port\n";
        }
        if (msg) {
          msg += "是否正確";

          alert(msg);
          return false;
        }
      }
      return true;
    }

    function submitForm(e) {
      document.querySelector("form").submit();
    }
  </script>
</html>
